<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecteur AY - Visualiseur & Documentation</title>

  <script src="ayumi.js"></script>
  <script src="player_comp.js"></script>

  <style>
    /* --- STYLE GLOBAL DARK THEME --- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #ddd;
    }

    h1 {
      color: #fff;
      font-size: 24px;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    /* --- CONTROLES --- */
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      transition: background 0.2s, transform 0.1s;
    }

    button:hover {
      background: #444;
      border-color: #777;
    }

    button:active {
      transform: translateY(1px);
    }

    /* --- VISUALISATION (Spectre & Scope) --- */
    .viz-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 25px;
      margin-bottom: 25px;
    }

    .viz-box {
      background: #111;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .viz-label {
      color: #31c6c6; /* Cyan r√©tro */
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 10px;
      width: 100%;
      text-align: left;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }

    canvas {
      width: 100%;
      height: 120px;
      background: #000;
      border-radius: 4px;
      border: 1px solid #222;
    }

    /* --- DEBUGGER --- */
    #debug {
      margin-top: 20px;
      padding: 15px;
      background: #000;
      color: #0f0;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      white-space: pre;
      border-radius: 6px;
      border: 1px solid #333;
      box-shadow: inset 0 0 10px #111;
      margin-bottom: 40px;
    }

    /* --- DETAILS / DOCUMENTATION --- */
    /* On garde le style "document papier" pour les tables pour la lisibilit√© */
    details {
      margin-top: 20px;
      background: #e0e0e0; /* Fond clair pour contraster avec le body sombre */
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #444;
      color: #000;
    }

    summary {
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      color: #000;
      margin-bottom: 10px;
    }

    details h2 { color: #000; margin-top: 0; }
    details p, details li { color: #333; }

    /* Tables */
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #999;
    }
  </style>
</head>

<body>

  <h1>Lecteur AY ‚Äì Visualiseur Audio & Docs</h1>

  <div style="margin-bottom: 20px;">
    <button onclick="selectFile()">üìÇ Charger s√©quence</button>
    <input type="file" id="fileInput" accept="*/*" style="display:none" onchange="loadCompressed(event)">

    <button onclick="startAudio()">‚ñ∂ Lecture</button>
    <button onclick="pauseAudio()">‚è∏ Pause</button>
  </div>

  <div class="viz-container">
    <div class="viz-box">
      <div class="viz-label">Analyseur de Spectre (FFT)</div>
      <canvas id="spectrumCanvas" width="512" height="120"></canvas>
    </div>
    <div class="viz-box">
      <div class="viz-label">Oscilloscope (Waveform)</div>
      <canvas id="scopeCanvas" width="512" height="120"></canvas>
    </div>
  </div>

  <div id="debug">Debugger en attente‚Ä¶ Chargez un fichier.</div>

  <details>
    <summary>
      Afficher le tableau des registres AY-3-8910
    </summary>

    <table border="1" cellpadding="6" cellspacing="0" style="margin-top:15px; background:white;">
      <tbody>
        <tr>
          <td colspan="2">Register \ bit</td>
          <td align="center">B7</td><td align="center">B6</td><td align="center">B5</td>
          <td align="center">B4</td><td align="center">B3</td><td align="center">B2</td>
          <td align="center">B1</td><td align="center">B0</td>
        </tr>

        <tr>
          <td>R0</td><td rowspan="2">Channel A Tone Period</td>
          <td colspan="8" align="center">8-Bit Fine Tune A</td>
        </tr>
        <tr>
          <td>R1</td><td colspan="4" bgcolor="gray"></td>
          <td colspan="4" align="center">4-Bit Coarse Tune A</td>
        </tr>

        <tr>
          <td>R2</td><td rowspan="2">Channel B Tone Period</td>
          <td colspan="8" align="center">8-Bit Fine Tune B</td>
        </tr>
        <tr>
          <td>R3</td><td colspan="4" bgcolor="gray"></td>
          <td colspan="4" align="center">4-Bit Coarse Tune B</td>
        </tr>

        <tr>
          <td>R4</td><td rowspan="2">Channel C Tone Period</td>
          <td colspan="8" align="center">8-Bit Fine Tune C</td>
        </tr>
        <tr>
          <td>R5</td><td colspan="4" bgcolor="gray"></td>
          <td colspan="4" align="center">4-Bit Coarse Tune C</td>
        </tr>

        <tr>
          <td>R6</td><td>Noise period</td>
          <td colspan="3" bgcolor="gray"></td>
          <td colspan="5" align="center">5-Bit Period control</td>
        </tr>

        <tr>
          <td rowspan="2">R7</td><td rowspan="2">Enable (bit 0 = on, 1 = off)</td>
          <td colspan="2" align="center">IN/OUT</td>
          <td colspan="3" align="center">Noise</td>
          <td colspan="3" align="center">Tone</td>
        </tr>
        <tr>
          <td align="center">IOB</td><td align="center">IOA</td>
          <td align="center">C</td><td align="center">B</td><td align="center">A</td>
          <td align="center">C</td><td align="center">B</td><td align="center">A</td>
        </tr>

        <tr>
          <td>R8</td><td>Channel A Envelope on/off, Volume</td>
          <td colspan="2" bgcolor="gray"></td>
          <td align="center">Env</td>
          <td colspan="5" align="center">volume</td>
        </tr>

        <tr>
          <td>R9</td><td>Channel B Envelope on/off, Volume</td>
          <td colspan="2" bgcolor="gray"></td>
          <td align="center">Env</td>
          <td colspan="5" align="center">volume</td>
        </tr>

        <tr>
          <td>R10</td><td>Channel C Envelope on/off, Volume</td>
          <td colspan="2" bgcolor="gray"></td>
          <td align="center">Env</td>
          <td colspan="5" align="center">volume</td>
        </tr>

        <tr>
          <td>R11</td><td rowspan="2">Envelope Period</td>
          <td colspan="8" align="center">8-Bit Fine Tune Envelope</td>
        </tr>
        <tr>
          <td>R12</td><td colspan="4" bgcolor="gray"></td>
          <td colspan="4" align="center">4-Bit Coarse Tune Envelope</td>
        </tr>

        <tr>
          <td>R13</td><td>Envelope Shape/Cycle</td>
          <td colspan="4" bgcolor="gray"></td>
          <td>CONT</td><td>ATT</td><td>ALT</td><td>HOLD</td>
        </tr>

        <tr>
          <td>R14</td><td>I/O Port A Data Store</td>
          <td colspan="8" align="center">8-Bit Parallel I/O on Port A</td>
        </tr>

        <tr>
          <td>R15</td><td>I/O Port B Data Store</td>
          <td colspan="8" align="center">8-Bit Parallel I/O on Port B</td>
        </tr>
      </tbody>
    </table>
  </details>

  <details>
    <summary>
      Tableau des formes d‚Äôenveloppe (R13)
    </summary>

    <table border="1" cellpadding="6" cellspacing="0" style="margin-top:15px; background:white;">
      <tbody>

        <tr>
          <th colspan="5" bgcolor="#31c6c6" width="50%">R13 Bits</th>
          <th rowspan="3" bgcolor="#31c6c6" width="50%">
            GRAPHICAL REPRESENTATION OF ENVELOPE GENERATOR OUTPUT (E3 E2 E1 E0)
          </th>
        </tr>

        <tr>
          <th bgcolor="#31c6c6">B3</th>
          <th bgcolor="#31c6c6">B2</th>
          <th bgcolor="#31c6c6">B1</th>
          <th bgcolor="#31c6c6">B0</th>
          <th bgcolor="#31c6c6" rowspan="2">Decimal<br>representation</th>
        </tr>

        <tr>
          <th bgcolor="#31c6c6">Continue</th>
          <th bgcolor="#31c6c6">Attack</th>
          <th bgcolor="#31c6c6">Alternate</th>
          <th bgcolor="#31c6c6">Hold</th>
        </tr>

        <tr>
          <td align="center">0</td><td align="center">0</td>
          <td bgcolor="gray" align="center">x</td><td bgcolor="gray" align="center">x</td>
          <td align="center">0,1,2,3</td>
          <td><img src="graphics/env01.gif" alt="[Envelope shape 00xx]"></td>
        </tr>

        <tr>
          <td align="center">0</td><td align="center">1</td>
          <td bgcolor="gray" align="center">x</td><td bgcolor="gray" align="center">x</td>
          <td align="center">4,5,6,7</td>
          <td><img src="graphics/env02.gif" alt="[Envelope shape 01xx]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">0</td>
          <td align="center">0</td><td align="center">0</td>
          <td align="center">8</td>
          <td><img src="graphics/env03.gif" alt="[Envelope shape 1000]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">0</td>
          <td align="center">0</td><td align="center">1</td>
          <td align="center">9</td>
          <td><img src="graphics/env04.gif" alt="[Envelope shape 1001]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">0</td>
          <td align="center">1</td><td align="center">0</td>
          <td align="center">10</td>
          <td><img src="graphics/env05.gif" alt="[Envelope shape 1010]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">0</td>
          <td align="center">1</td><td align="center">1</td>
          <td align="center">11</td>
          <td><img src="graphics/env06.gif" alt="[Envelope shape 1011]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">1</td>
          <td align="center">0</td><td align="center">0</td>
          <td align="center">12</td>
          <td><img src="graphics/env07.gif" alt="[Envelope shape 1100]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">1</td>
          <td align="center">0</td><td align="center">1</td>
          <td align="center">13</td>
          <td><img src="graphics/env08.gif" alt="[Envelope shape 1101]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">1</td>
          <td align="center">1</td><td align="center">0</td>
          <td align="center">14</td>
          <td><img src="graphics/env09.gif" alt="[Envelope shape 1110]"></td>
        </tr>

        <tr>
          <td align="center">1</td><td align="center">1</td>
          <td align="center">1</td><td align="center">1</td>
          <td align="center">15</td>
          <td><img src="graphics/env10.gif" alt="[Envelope shape 1111]"></td>
        </tr>

        <tr>
          <td colspan="5"></td>
          <td>
            <img src="graphics/ep.gif" alt="[Envelope Period Note]">
            EP = R12 √ó 256 + R11 (dur√©e d‚Äôun cycle d‚Äôenveloppe)
          </td>
        </tr>

      </tbody>
    </table>
  </details>

  <br>
  <img src="graphics/ay_internal.png" alt="[AY-3-8910 internal]" style="max-width:100%; border-radius:6px; border:1px solid #444;">

  <details>
    <summary>
      Explication de la compression Delta + Bitmask
    </summary>

    <h2>M√©thode Delta + Bitmask</h2>
    <p>La compression Delta consiste √† stocker :</p>
    <ul>
      <li><b>Frame 0</b> : les 14 registres bruts (aucune compression)</li>
      <li><b>Frame N</b> : uniquement les registres qui ont chang√©</li>
    </ul>
    <p>Pour chaque frame compress√©e, on stocke :</p>
    <pre>bitmask_low   (1 octet)  ‚Üí registres R0 √† R7
bitmask_high  (1 octet)  ‚Üí registres R8 √† R13
valeurs modifi√©es (0 √† 14 octets)</pre>

    <hr>
    <h2>Exemple</h2>
    <h3>Frame 0 (stock√©e brute)</h3>
    <pre>3B 00 00 00 00 00 00 FF 00 00 00 80 01 FF</pre>

    <h3>Frame 1 (Compress√©e)</h3>
    <p><b>Frame originale :</b> 7F 00 FD 02 00 00 00 F8 0F 0F 00 80 01 FF</p>
    <p><b>Changements :</b> R0, R2, R3, R7, R8, R9</p>
    <p><b>R√©sultat compress√© :</b> 8D 03 7F FD 02 F8 0F 0F</p>

    <p>
      ‚Üí <b>Gain : 33% d‚Äôespace √©conomis√©</b> sur cet exemple simple.<br>
      ‚Üí Sur une musique compl√®te, le gain est souvent entre <b>√ó4 et √ó10</b>.
    </p>
  </details>

</body>
</html>